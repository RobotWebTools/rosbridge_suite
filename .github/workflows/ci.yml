name: CI

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      - run: pip install bandit codespell flake8
      - run: bandit --recursive --skip B101,B110,B311 .
      - run: codespell
      - run: flake8

  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Test supported ROS 2 distributions
          # https://docs.ros.org/en/rolling/Releases.html
          - ros: foxy
            ubuntu: focal
          - ros: galactic
            ubuntu: focal

    name: ROS 2 ${{ matrix.ros }} (${{ matrix.ubuntu }})
    runs-on: ubuntu-20.04
    container:
      image: ros:${{ matrix.ros }}-ros-base-${{ matrix.ubuntu }}

    steps:
      - uses: actions/checkout@v2
        with:
          path: ros_ws/src

      # Install bare minimum dependencies to run ros-tooling/action-ros-ci
      # All build and test dependencies should live in package.xml files
      - name: Install CI dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            lcov \
            python3-colcon-coveragepy-result \
            python3-colcon-lcov-result

      - uses: ros-tooling/action-ros-ci@v0.2
        with:
          target-ros2-distro: ${{ matrix.ros }}
